---
title: "NYC Inclusion"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r include=FALSE}

#install and load packages
# install.packages("tidyverse")
### load libraries
library(tidyverse)
library(readr)

### bring in raw data
X2017_2018_SCHOOL_LEVEL_CLASS_SIZE_REPORT <- read_csv("/cloud/project/raw/2017-2018_SCHOOL_LEVEL_CLASS_SIZE_REPORT.csv")
#take out class size because that doesn't include D75
X2018_2019_School_Demographic_Snapshot <- read_csv("/cloud/project/raw/2018-2019_School_Demographic_Snapshot.csv")
X2013_2019_Attendance_Results_School <- read_csv("/cloud/project/raw/2013-2019_Attendance_Results_-_School.csv")

################
### Step I: Create the full_school data file
################
### step 1: from the demographics, get one row per DBN of just the demographics (they stay constant for 2017)
demos<- X2018_2019_School_Demographic_Snapshot %>%
  filter(Year == "2017-18") %>%
  select(DBN, `School Name`, `Total Enrollment`, `Economic Need Index`, '% Male', '% Black', '% White', '% Students with Disabilities', '% Poverty')
### step 2: merge the Grade + Program Type variables, then spread 
classes <- X2017_2018_SCHOOL_LEVEL_CLASS_SIZE_REPORT %>%
  mutate(program_type_grade = paste(`Program Type`, '-', `Grade Level`)) %>%
  select(DBN, program_type_grade, `Number of Classes`)%>%
  # mutate(grouped_id = row_number()) %>%
  spread(program_type_grade, `Number of Classes`)
#replace NA with 0
classes[is.na(classes)] <- 0
#rename columns
classes <- classes %>%
  rename(GT1 = "G&T - 1", GT2 = "G&T - 2", GT3 = "G&T - 3",
         GT4 = "G&T - 4", GT5 = "G&T - 5", GTK = "G&T - K",
         GE1 = "Gen Ed - 1",  GE2 = "Gen Ed - 2",  GE3 = "Gen Ed - 3", 
         GE4 = "Gen Ed - 4",  GE5 = "Gen Ed - 5",  GE6 = "Gen Ed - 6", 
         GE7 = "Gen Ed - 7",  GE8 = "Gen Ed - 8",  GEK = "Gen Ed - K", 
         ICT1 = "ICT - 1",   ICT2 = "ICT - 2",   ICT3 = "ICT - 3", 
         ICT4 = "ICT - 4",   ICT5 = "ICT - 5",   ICT6 = "ICT - 6",
         ICT7 = "ICT - 7",   ICT8 = "ICT - 8",ICTK = "ICT - K",
         ICTGT1 = "ICT & G&T - 1",  ICTGT2 = `ICT & G&T - 2`,  ICTGT3 = `ICT & G&T - 3`,
         ICTGT4 = "ICT & G&T - 4",  ICTGT5 = `ICT & G&T - 5`,  ICTGTK = `ICT & G&T - K`,
         SC121 = "SC 12:1 - K-8 SC", SC1211 = "SC 12:1:1 - K-8 SC", SC151 = "SC 15:1 - K-8 SC", 
         SC611 = "SC 6:1:1 - K-8 SC", SC811 = "SC 8:1:1 - K-8 SC")
### step 2A: create a binary indicator of whether middle school, K-8, or K-5
classes <- classes %>%
  mutate(middle_levels = ifelse((GE6 | GE7 | GE8 > 1) |(ICT6 | ICT7 | ICT8 > 1) , 1,0),
         elementary_levels = ifelse((GE1 | GE2 | GE3 |GE4| GE5 >1) | (ICT1 |ICT2|ICT3|ICT4|ICT5 > 1), 1,0),
         self_contained = ifelse(SC121 | SC1211 | SC151 | SC611 | SC811 > 1, 1,0),
         gifted = ifelse(GT1 | GT2 | GT3 | GT4 |GT5 |GTK >1, 1,0),
         self_contained_and_gifted = ifelse(self_contained ==1 & gifted ==1,1,0))
classes <- classes %>%
  mutate(school_type = case_when(middle_levels ==1 & elementary_levels ==0 ~ "Middle",
                                 middle_levels ==0 & elementary_levels ==1 ~ "Elementary",
                                 middle_levels == 1 & elementary_levels ==1 ~ "K to 8",
                                 middle_levels ==0 & elementary_levels ==0 ~ "gifted"),
         class_option = case_when(self_contained ==1 & gifted ==0 ~ "SC",
                                  self_contained ==1 & gifted ==1 ~ "SC and GT",
                                  self_contained ==0 & gifted == 0 ~ "no option",
                                  self_contained == 0 & gifted ==1 ~ "GT"))
classes <- classes %>%
  mutate(borough = case_when(str_detect(`DBN`, "X") ~"Bronx",
                             str_detect(`DBN`, "Q") ~ "Queens",
                             str_detect(`DBN`, "K") ~"Brooklyn",
                             str_detect(`DBN`, "M") ~ "Manhattan",
                             str_detect(`DBN`, "R") ~"Staten Island"))
## step 3: merge with the demographics
merged <- merge(demos, classes, by = "DBN") %>%
  distinct()

### step 4: get attendance
attendance<- X2013_2019_Attendance_Results_School %>%
  filter(`Grade` == "All Grades" & `Demographic Variable` == "All Students") %>%
  select(DBN, '% Attendance', '% Chronically Absent', 'Year') %>%
  filter(Year == '2017-18')
### merge with attendance
merged <- merge(merged, attendance, by = "DBN")
write.csv(merged, file = "/cloud/project/data/full_school_data.csv")


```

## Data cleaning

Build a dataset from raw NYC data, where for 1125 schools, we have enrollment, attendance, etc.

```{r}
head(merged[,1:10])
```


## Raw differences

Between treatment and control, attendance and chronic absenteeism are statistically different (p value sig by t test for all covarites)

```{r message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse)
full_school_data <- read_csv("data/full_school_data.csv")
### edit the frame
working_data <- full_school_data %>%
  rename(TotalEnrollment = `Total Enrollment`,
         ENI = `Economic Need Index`,
         PercentBlack = `% Black`,
         PercentWhite = `% White`,
         PercentSWD = `% Students with Disabilities`,
         PercentPoverty = `% Poverty`,
         AllStudents_CA = `% Chronically Absent`,
         AllStudents_PA = `% Attendance`) %>%
  mutate(treatment = ifelse(self_contained ==0, 1,0))%>%
  select(DBN, `TotalEnrollment`, ENI, PercentBlack, PercentSWD, PercentPoverty, self_contained,
        AllStudents_CA, AllStudents_PA, treatment, borough) %>%
  na.omit()
## without matching, t.test is different in all of the covariates.
school_covariates <- c('ENI', 'PercentBlack', 'PercentSWD', 'PercentPoverty')
with(working_data, t.test(AllStudents_PA ~ self_contained))
with(working_data, t.test(AllStudents_CA ~ self_contained))
with(working_data, t.test(ENI ~ self_contained))
with(working_data, t.test(PercentBlack ~ self_contained))
with(working_data, t.test(PercentSWD ~ self_contained))
with(working_data, t.test(PercentPoverty ~ self_contained))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
### t tests
## Attendance is sig different
working_data %>%
  group_by(self_contained) %>%
  summarise(mean_attendance = mean(as.numeric(AllStudents_PA)),
            mean_chronic_absent = mean(as.numeric(AllStudents_CA)))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
working_data %>%
  group_by(self_contained) %>%
  select(one_of(school_covariates)) %>%
  summarise_all(funs(mean(., na.rm=T)))

```
## Regression Estimates

Treatment is sig predictor of attendance and absenteeism, as are multiple covariates. Covariates are also predictors of treatment. Drives matching 

```{r}
### Predict Attendance and Absenteeism
model <- lm(AllStudents_PA ~ treatment, data = working_data)
summary(model)
model <- lm(AllStudents_CA ~ treatment , data = working_data)
summary(model)
## multiple regression
model <- lm(AllStudents_CA ~ self_contained + 
              TotalEnrollment + ENI + PercentBlack +PercentSWD +PercentPoverty +
              factor(borough), data = working_data)
summary(model)
model <- lm(AllStudents_PA ~ self_contained + 
              TotalEnrollment + ENI + PercentBlack +PercentSWD +PercentPoverty +
              factor(borough), data = working_data)
summary(model)


## Predict treatment
model <- lm(treatment ~ TotalEnrollment + ENI + PercentBlack +PercentSWD +PercentPoverty , data = working_data)
summary(model)


```





